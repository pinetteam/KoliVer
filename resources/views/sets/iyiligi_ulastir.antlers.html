<div class="container-fluid">
    {{ form:iyiligi_ulastir class="my-8 needs-validation" novalidate  store="true"  redirect="tesekkur-sayfasi"
    }}
    <input type="text" class="hidden" name="{{ honeypot ?? 'honeypot' }}">

    {{ if submission:errors }}
    <div class="alert alert-danger">
        <h4>Ödeme İşlemi Başarısız</h4>

        {{ submission:errors }}
        <p>{{ value }}</p>
        {{ /submission:errors }}

        <div class="mt-3">
            <a href="/odeme" class="btn btn-primary">Tekrar Dene</a>
        </div>
    </div>
    {{ /if }}

    {{ if submission:success }}
    <div class="alert alert-success">
        <h4>Ödeme Başarılı!</h4>
        <p>İşleminiz tamamlandı.</p>
    </div>
    {{ /if }}

    {{ if !submission:success and !submission:errors }}
    <!-- Form içeriği -->
    {{ /if }}


    <!-- Sepet Özeti -->
    <div class="card mb-4">
        <div class="card-header text-white" style="background-color: #0677d8">
            <h5 class="mb-0">Koli Özeti</h5>
        </div>
        <div class="card-body p-0" id="cart-summary">
            <!-- JavaScript ile sepet içeriği burada gösterilecek -->
            <div id="cart-items-container" class="list-group list-group-flush"></div>

            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Toplam:</h5>
                    <h5 class="mb-0 fw-bold"><span id="cart-total-amount">0.00</span> ₺</h5>
                </div>
            </div>
        </div>
        <div id="empty-cart-message" class="card-body text-center d-none">
            <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
            <p class="mt-3">Sepetiniz boş. Lütfen ödeme öncesi ürün ekleyin.</p>
            <a href="/" class="btn btn-primary">Ürünlere Dön</a>
        </div>
    </div>

    <!-- Kişisel Bilgiler Bölümü -->
    <h4 class="mb-3">Kişisel Bilgiler</h4>

    <div class="form-group mb-4">
        <label for="ad_soyad" class="form-label fw-bold">Ad Soyad</label>
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
            <input type="text" name="ad_soyad" id="ad_soyad" class="form-control" required>
        </div>
        <div class="invalid-feedback">Lütfen ad ve soyadınızı giriniz.</div>
    </div>

    <div class="form-group mb-4">
        <label for="tc_kimlik" class="form-label fw-bold">TC Kimlik No</label>
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-card-heading"></i></span>
            <input type="text" name="tc_kimlik" id="tc_kimlik" class="form-control" maxlength="11" pattern="[0-9]{11}">
        </div>
        <div class="invalid-feedback">Lütfen geçerli bir TC Kimlik numarası giriniz.</div>
    </div>

    <div class="form-group mb-4">
        <label for="telefon" class="form-label fw-bold">Telefon</label>
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-phone"></i></span>
            <input type="text" name="telefon" id="telefon" class="form-control" required placeholder="5XX XXX XX XX" maxlength="14">
        </div>
        <small class="form-text text-muted">Başında 0 olmadan girin (örn: 532 123 45 67)</small>
        <div class="invalid-feedback">Lütfen geçerli bir telefon numarası giriniz.</div>
    </div>

    <div class="form-group mb-4">
        <label for="mail" class="form-label fw-bold">E-Posta Adresi</label>
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
            <input type="email" name="mail" id="mail" class="form-control">
        </div>
        <div class="invalid-feedback">Lütfen geçerli bir doğum tarihi giriniz. (18 yaş üstü)</div>
    </div>

    <div class="form-group mb-4">
        <label for="sehir" class="form-label fw-bold">Şehir Seçiniz</label>
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-geo-alt-fill"></i></span>
            <select name="sehir" id="sehir" class="form-control" required>
                <option value="">Şehir Seçiniz</option>
                <option value="adana">Adana</option>
                <option value="adiyaman">Adıyaman</option>
                <option value="afyonkarahisar">Afyonkarahisar</option>
                <option value="agri">Ağrı</option>
                <option value="amasya">Amasya</option>
                <option value="ankara">Ankara</option>
                <option value="antalya">Antalya</option>
                <option value="artvin">Artvin</option>
                <option value="aydin">Aydın</option>
                <option value="balikesir">Balıkesir</option>
                <option value="bilecik">Bilecik</option>
                <option value="bingol">Bingöl</option>
                <option value="bitlis">Bitlis</option>
                <option value="bolu">Bolu</option>
                <option value="burdur">Burdur</option>
                <option value="bursa">Bursa</option>
                <option value="canakkale">Çanakkale</option>
                <option value="cankiri">Çankırı</option>
                <option value="corum">Çorum</option>
                <option value="denizli">Denizli</option>
                <option value="diyarbakir">Diyarbakır</option>
                <option value="edirne">Edirne</option>
                <option value="elazig">Elazığ</option>
                <option value="erzincan">Erzincan</option>
                <option value="erzurum">Erzurum</option>
                <option value="eskisehir">Eskişehir</option>
                <option value="gaziantep">Gaziantep</option>
                <option value="giresun">Giresun</option>
                <option value="gumushane">Gümüşhane</option>
                <option value="hakkari">Hakkari</option>
                <option value="hatay">Hatay</option>
                <option value="isparta">Isparta</option>
                <option value="mersin">Mersin</option>
                <option value="istanbul">İstanbul</option>
                <option value="izmir">İzmir</option>
                <option value="kars">Kars</option>
                <option value="kastamonu">Kastamonu</option>
                <option value="kayseri">Kayseri</option>
                <option value="kirklareli">Kırklareli</option>
                <option value="kirsehir">Kırşehir</option>
                <option value="kocaeli">Kocaeli</option>
                <option value="konya">Konya</option>
                <option value="kutahya">Kütahya</option>
                <option value="malatya">Malatya</option>
                <option value="manisa">Manisa</option>
                <option value="kahramanmaras">Kahramanmaraş</option>
                <option value="mardin">Mardin</option>
                <option value="mugla">Muğla</option>
                <option value="mus">Muş</option>
                <option value="nevsehir">Nevşehir</option>
                <option value="nigde">Niğde</option>
                <option value="ordu">Ordu</option>
                <option value="rize">Rize</option>
                <option value="sakarya">Sakarya</option>
                <option value="samsun">Samsun</option>
                <option value="siirt">Siirt</option>
                <option value="sinop">Sinop</option>
                <option value="sivas">Sivas</option>
                <option value="tekirdag">Tekirdağ</option>
                <option value="tokat">Tokat</option>
                <option value="trabzon">Trabzon</option>
                <option value="tunceli">Tunceli</option>
                <option value="sanliurfa">Şanlıurfa</option>
                <option value="usak">Uşak</option>
                <option value="van">Van</option>
                <option value="yozgat">Yozgat</option>
                <option value="zonguldak">Zonguldak</option>
                <option value="aksaray">Aksaray</option>
                <option value="bayburt">Bayburt</option>
                <option value="karaman">Karaman</option>
                <option value="kirikkale">Kırıkkale</option>
                <option value="batman">Batman</option>
                <option value="sirnak">Şırnak</option>
                <option value="bartin">Bartın</option>
                <option value="ardahan">Ardahan</option>
                <option value="igdir">Iğdır</option>
                <option value="yalova">Yalova</option>
                <option value="karabuk">Karabük</option>
                <option value="kilis">Kilis</option>
                <option value="osmaniye">Osmaniye</option>
                <option value="duzce">Düzce</option>
            </select>
        </div>
        <div class="invalid-feedback">Lütfen bir şehir seçiniz.</div>
    </div>

    <!-- Ödeme Bilgileri Bölümü -->
    <h4 class="mb-3 mt-5 fw-bold">Ödeme Bilgileri</h4>

    <div class="card mb-4">
        <div class=" ">
            <div id="payment-iframe-container">
                <iframe
                    id="payment-iframe"

                    width="100%"
                    height="500"
                    frameborder="0"
                    style="border: none; width: 100%;"
                    >
                </iframe>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Önce sepeti ve toplam tutarı hesapla
            const cart = JSON.parse(localStorage.getItem('shopping_cart')) || [];
            let cartTotal = 0;

            // Sepet içeriğini oluştur ve toplam tutarı hesapla
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                cartTotal += itemTotal;
                // (Sepet içeriği oluşturma kodunuz burada devam eder)
            });

            // Toplam tutarı form elementine ata
            document.getElementById('toplam_tutar').value = cartTotal.toFixed(2);
            document.getElementById('cart-total-amount').textContent = cartTotal.toFixed(2);

            // Şimdi iframe'i ayarla (tutarın hesaplanması ve atanmasından sonra)
            const paymentIframe = document.getElementById('payment-iframe');

            // iframe src'yi toplam tutar ile ayarla
            const totalAmount = cartTotal.toFixed(2);
            paymentIframe.src = `https://koliver.ankara.bel.tr/test.php?tutar=${totalAmount}`;

            console.log('İframe tutar:', totalAmount); // Debug için

            // iframe'den gelen mesajları dinle
            window.addEventListener('message', function(event) {
                // Güvenlik kontrolü
                if (event.origin === 'https://koliver.ankara.bel.tr') {
                    const response = event.data;

                    if (response.status === 'success') {
                        // Ödeme başarılı
                        document.getElementById('odeme_durumu').value = 'success';
                        document.getElementById('islem_id').value = response.transaction_id || '';

                        // Form göndermeyi etkinleştir
                        document.getElementById('payment-submit-btn').disabled = false;
                    } else {
                        // Ödeme başarısız
                        document.getElementById('odeme_durumu').value = 'error';

                        // Hata mesajını göster
                        alert('Ödeme işlemi sırasında bir hata oluştu: ' + (response.message || 'Bilinmeyen hata'));
                    }
                }
            });





        });
    </script>
<!--    <div class="form-group mb-4">-->
<!--        <label for="kart_no" class="form-label fw-bold">Kart Numarası</label>-->
<!--        <div class="input-group">-->
<!--            <span class="input-group-text"><i class="bi bi-credit-card"></i></span>-->
<!--            <input type="text" name="kart_no" id="kart_no" class="form-control"-->
<!--                   placeholder="XXXX XXXX XXXX XXXX" required maxlength="19">-->
<!--        </div>-->
<!--        <div class="invalid-feedback">Lütfen geçerli bir kart numarası giriniz.</div>-->
<!--    </div>-->

<!--    <div class="row mb-4">-->
<!--        <div class="col-md-6">-->
<!--            <label class="form-label fw-bold">Son Kullanma Tarihi</label>-->
<!--            <div class="row">-->
<!--                <div class="col-6">-->
<!--                    <div class="input-group">-->
<!--                        <span class="input-group-text"><i class="bi bi-calendar-month"></i></span>-->
<!--                        <input type="text" name="kart_ay" id="kart_ay" class="form-control"-->
<!--                               placeholder="AA" required maxlength="2">-->
<!--                    </div>-->
<!--                    <div class="invalid-feedback">Ay giriniz</div>-->
<!--                </div>-->
<!--                <div class="col-6">-->
<!--                    <div class="input-group">-->
<!--                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>-->
<!--                        <input type="text" name="kart_yil" id="kart_yil" class="form-control"-->
<!--                               placeholder="YYYY" required maxlength="4">-->
<!--                    </div>-->
<!--                    <div class="invalid-feedback">Yıl giriniz</div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

<!--        <div class="col-md-6">-->
<!--            <label for="kart_cvv" class="form-label fw-bold">CVV Kodu</label>-->
<!--            <div class="input-group">-->
<!--                <span class="input-group-text"><i class="bi bi-lock"></i></span>-->
<!--                <input type="text" name="kart_cvv" id="kart_cvv" class="form-control"-->
<!--                       placeholder="XXX" required maxlength="4">-->
<!--            </div>-->
<!--            <div class="invalid-feedback">Lütfen CVV kodunu giriniz.</div>-->
<!--        </div>-->
<!--    </div>-->

    <!-- Sepet verilerini saklayacak gizli alan -->
    <input type="hidden" name="siparis_detayi" id="siparis_detayi" value="">
    <input type="hidden" name="toplam_tutar" id="toplam_tutar" value="0">

    {{ if submission:errors }}
    <div class="alert alert-danger">
        <h4>Ödeme İşlemi Başarısız</h4>

        {{ submission:errors }}
        <p>{{ key }}: {{ value }}</p>
        {{ /submission:errors }}

        <div class="mt-3">
            <a href="/odeme" class="btn btn-primary">Tekrar Dene</a>
        </div>
    </div>
    {{ /if }}

    {{ if errors }}
    <div class="alert alert-danger">
        <h4>Form Hataları</h4>

        {{ errors }}
        <p>{{ value }}</p>
        {{ /errors }}
    </div>
    {{ /if }}
    <!-- Ödeme işlemini başlat -->

    <div class="d-flex justify-content-center mt-4 flex-column align-items-center">
        <button type="submit" class="btn btn-primary px-4 py-2" id="payment-submit-btn">
            <i class="bi bi-heart-fill me-2"></i>İyiliği Ulaştır
        </button>
        <!-- Bilgilendirme metni JavaScript ile eklenecek -->
    </div>
    {{ if errors }}
    <div class="alert alert-danger mt-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ errors }}
        {{ value }}<br>
        {{ /errors }}
    </div>
    {{ /if }}
    {{ /form:iyiligi_ulastir }}

    <!-- Güvenli ödeme bilgisi -->
    <div class="card mt-4 mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center">
                <i class="bi bi-shield-lock-fill text-success me-3" style="font-size: 2rem;"></i>
                <div>
                    <h5 class="mb-1">Güvenli Ödeme</h5>
                    <p class="mb-0 text-muted">Tüm ödemeleriniz 256-bit SSL sertifikası ile güvenle korunmaktadır.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cart = JSON.parse(localStorage.getItem('shopping_cart')) || [];
        const submitButton = document.getElementById('payment-submit-btn');
        const form = document.querySelector('form.needs-validation');

        // Sepet kontrolleri
        if (cart.length === 0) {
            document.getElementById('cart-summary').classList.add('d-none');
            document.getElementById('empty-cart-message').classList.remove('d-none');
            submitButton.disabled = true;
        } else {
            // Sepet içeriğini oluştur
            const cartItemsContainer = document.getElementById('cart-items-container');
            let cartTotal = 0;

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                cartTotal += itemTotal;

                const listItem = document.createElement('div');
                listItem.className = 'list-group-item';
                listItem.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="me-3" style="width: 60px; height: 60px;">
                    <div class="bg-light rounded d-flex justify-content-center align-items-center h-100">
                        ${item.imageUrl ?
                    `<img src="${item.imageUrl}" alt="${item.name}" class="img-fluid rounded"
                            style="max-width: 100%; max-height: 100%; object-fit: contain;">` :
                    `<div class="d-flex align-items-center justify-content-center h-100">
                                <i class="bi bi-image text-muted"></i>
                            </div>`
                }
                    </div>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">${item.name}</h6>
                            <small class="text-muted">${item.quantity} adet x ${item.price.toFixed(2)} ₺</small>
                        </div>
                        <span class="fw-bold">${itemTotal.toFixed(2)} ₺</span>
                    </div>
                </div>
            </div>
            `;

                cartItemsContainer.appendChild(listItem);
            });

            // Toplam tutarı güncelle
            document.getElementById('cart-total-amount').textContent = cartTotal.toFixed(2);
            document.getElementById('toplam_tutar').value = cartTotal.toFixed(2);
            document.getElementById('siparis_detayi').value = JSON.stringify(cart);
        }

        // Ödeme butonu başlangıçta devre dışı
        submitButton.disabled = true;

        // Bilgilendirme metni ekle
        const paymentInfo = document.createElement('small');
        paymentInfo.className = 'text-muted mt-2 text-center';
        paymentInfo.innerHTML = '<i class="bi bi-info-circle me-1"></i>Ödeme işlemi tamamlandıktan sonra buton etkinleşecektir.';
        submitButton.parentNode.appendChild(paymentInfo);

        // Ödeme durumu takibi için değişken
        let paymentCompleted = false;

        // Ödeme durumu için hidden input ekle (sonuc.php için gerekli)
        if (!document.getElementById('odeme_durumu')) {
            const odemeInput = document.createElement('input');
            odemeInput.type = 'hidden';
            odemeInput.id = 'odeme_durumu';
            odemeInput.name = 'odeme_durumu';
            odemeInput.value = 'beklemede';
            form.appendChild(odemeInput);
        }

        // İşlem ID için hidden input ekle (sonuc.php için gerekli)
        if (!document.getElementById('islem_id')) {
            const islemInput = document.createElement('input');
            islemInput.type = 'hidden';
            islemInput.id = 'islem_id';
            islemInput.name = 'islem_id';
            islemInput.value = '';
            form.appendChild(islemInput);
        }

        // Form submit kontrolü ekle
        form.addEventListener('submit', function(event) {
            if (!paymentCompleted) {
                event.preventDefault();
                event.stopPropagation();

                // Uyarı göster
                const alertContainer = document.createElement('div');
                alertContainer.className = 'alert alert-danger mt-3';
                alertContainer.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>Lütfen önce ödeme işlemini tamamlayınız!';

                // Eğer daha önce eklenmiş alert varsa kaldır
                const existingAlert = document.querySelector('.alert.alert-danger');
                if (existingAlert) {
                    existingAlert.remove();
                }

                // Alert'i iframe container'ın altına ekle
                document.getElementById('payment-iframe-container').appendChild(alertContainer);

                // 3 saniye sonra alert'i kaldır
                setTimeout(() => {
                    alertContainer.remove();
                }, 3000);

                return false;
            }

            // Form validasyonu
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });

        // Form validasyonu
        Array.from(document.querySelectorAll('.needs-validation')).forEach(form => {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });

        // Kart numarası formatı (mevcut kodunuzda varsa bırakabilirsiniz)
        const kartNo = document.getElementById('kart_no');
        if (kartNo) {
            kartNo.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                let formattedValue = '';

                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formattedValue += ' ';
                    }
                    formattedValue += value[i];
                }

                e.target.value = formattedValue;
            });
        }

        // Telefon numarası formatı
        const telefonInput = document.getElementById('telefon');
        if (telefonInput) {
            telefonInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                let formattedValue = '';

                for (let i = 0; i < value.length; i++) {
                    if (i === 3 || i === 6 || i === 8) {
                        formattedValue += ' ';
                    }
                    formattedValue += value[i];
                }

                e.target.value = formattedValue;
            });
        }

        // iframe'den gelen mesajları dinle
        window.addEventListener('message', function(event) {
            // Mesajı konsola yazdır (debug için)
            console.log('iframe mesajı alındı:', event.origin, event.data);

            // Her türlü mesajı kabul edelim (debug için)
            const response = event.data;

            // Yanıt bir obje ve status değeri success ise
            if (response && response.status === 'success') {
                console.log('Ödeme başarılı, buton etkinleştiriliyor');

                // Ödeme durumu ve işlem ID'sini güncelle
                const odemeInput = document.getElementById('odeme_durumu') || document.createElement('input');
                odemeInput.type = 'hidden';
                odemeInput.id = 'odeme_durumu';
                odemeInput.name = 'odeme_durumu';
                odemeInput.value = 'success';

                const islemInput = document.getElementById('islem_id') || document.createElement('input');
                islemInput.type = 'hidden';
                islemInput.id = 'islem_id';
                islemInput.name = 'islem_id';
                islemInput.value = response.transaction_id || '';

                // Form varsa ekle
                const form = document.querySelector('form.needs-validation');
                if (form) {
                    if (!document.getElementById('odeme_durumu')) form.appendChild(odemeInput);
                    if (!document.getElementById('islem_id')) form.appendChild(islemInput);
                }

                // Ödeme tamamlandı olarak işaretle
                window.paymentCompleted = true;
                paymentCompleted = true;
                // Submit butonu
                const submitButton = document.getElementById('payment-submit-btn');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('btn-primary');
                    submitButton.classList.add('btn-success');
                }

                // Bilgilendirme metni
                const paymentInfo = document.querySelector('#payment-submit-btn + small') ||
                    document.createElement('small');

                paymentInfo.className = 'text-success mt-2 text-center';
                paymentInfo.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Ödeme işlemi başarılı! Şimdi "İyiliği Ulaştır" butonuna tıklayabilirsiniz.';

                if (!document.querySelector('#payment-submit-btn + small') && submitButton) {
                    submitButton.parentNode.appendChild(paymentInfo);
                }

                // Başarılı ödeme bildirimi
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success mt-3';
                successAlert.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Ödeme işlemi başarıyla tamamlandı. Şimdi "İyiliği Ulaştır" butonuna tıklayabilirsiniz.';

                // Mevcut alertleri kaldır
                const existingAlerts = document.querySelectorAll('.alert');
                existingAlerts.forEach(alert => alert.remove());

                // Alert ekle
                const container = document.getElementById('payment-iframe-container');
                if (container) container.appendChild(successAlert);

                // 5 saniye sonra alert'i kaldır
                setTimeout(() => {
                    successAlert.remove();
                }, 5000);
            }
        });

        // iframe src'yi toplam tutar ile ayarla

    });
</script>
